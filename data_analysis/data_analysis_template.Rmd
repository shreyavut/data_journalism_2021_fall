---
title: "Data Analysis Project"
author: "michael purdie, kylie rau, shreya vuttaluru"
date: "11/14/21"
output:
  html_document:
    theme: cerulean
    highlight: pygments
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction 

In this notebook, we are working with the [Washington Post police shooting database](https://github.com/washingtonpost/data-police-shootings) and the [Washington Post homicides database.](https://github.com/washingtonpost/data-homicides)

## Load libraries

Loading required libraries for this analysis.

```{r echo=FALSE, message=FALSE}
#essential libraries
library(tidyverse)
library(janitor)
library(lubridate)
#additional libraries 
library(sf)
library(tigris)
library(tidycensus)

install.packages("usmap")
library(usmap)

install.packages("censusxy")
library(censusxy)

```

## Load and Cleaning Data

In this section, describe the source of the data, write a basic data dictionary for data you are working with, and discuss any caveats or issues you discovered working with this data. 

## Quick Analysis based on loaded data: in looking at the police shootings data, everything looks relatively clean, so we don't foresee having to do any cleaning. We're choosing to focus on the geography of police shootings, so we need to use census data in order to figure out where exactly these police shootings are happening, and if there are certain neighborhoods (ex: majority-minority or low income) that are more affected by police shootings. We'll likely need to form some kind of relationship between the lat/long coordinates in this dataset and data from census tracts. 

```{r}
# Load required data
police_shootings <- read_csv("data/data-police-shootings-master/fatal-police-shootings-data.csv")

## census api key
census_api_key("82c33dd2db316b78367d3476bcb90d2abe65a69a", install = "TRUE", overwrite = TRUE)


```

## Working with the data 

## Deliverable 3 Summary: This week, we spent most of our time figuring out how to reverse geocode the coordinates given by the Washington Post so that we can eventually retrieve characteristics about the neighborhoods (census tracts) that the shootings occur in. Right now, we don’t have any particular findings, but now that we have geoid as its own separate column within our data, we’ll be able to call in census data via tidycensus and other packages and potentially join our tables in order to better narrow down the characteristics of neighborhoods that police shootings occur in more often. From there, we’ll have to do a little bit of sorting and filtering to better understand the data. 

``` {r}
## trying to make a map to generally understand where the shootings are
## getting some county data
counties <- counties() 
usa_counties <- counties %>%
  filter (STATEFP < "57")

## trying to fuck around with census xy

police_shootings <- read_csv("data/data-police-shootings-master/fatal-police-shootings-data.csv") %>%
    filter(!is.na(longitude)) 

## ok so it seems like we can only do one lat long at a time so... for loop? idk lets try

## first create empty data frame

police_shootings_sf <- tibble()

for (row_number in 1:nrow(police_shootings)) {
  
  #this makes a dataframe for each
  row_df<- police_shootings %>%
  slice(row_number)
  
  #store lat and long values
  longitude <- row_df$longitude
  latitude <- row_df$latitude
  census_results <- cxy_geography(longitude, latitude) %>%
    select(Census.Tracts.GEOID) %>%
    clean_names()
 
   row_df <- row_df %>%
     bind_cols(census_results) 
   
  
  #inding some rows
   police_shootings_sf <- police_shootings_sf %>%
    bind_rows(row_df) 
   
   print(paste0("finished ", row_number, " ", Sys.time()))
   
   if (row_number%%500 == 0) {
     filepath <- paste0("data/geocoded_results_", row_number, ".rds")
     write_rds(police_shootings_sf, filepath)
     police_shootings_sf <- as_tibble()
     
   }
     

}

write_rds(police_shootings_sf, "data/geocoded_results.rds")


## testingggggg
read_rds("data/geocoded_results_2500.rds")
## nice!

data1 <- read_rds("data/geocoded_results_500.rds")
data2 <- read_rds("data/geocoded_results_1000.rds")
data3 <- read_rds("data/geocoded_results_1500.rds")
data4 <- read_rds("data/geocoded_results_2000.rds")
data5 <- read_rds("data/geocoded_results_2500.rds")
data6 <- read_rds("data/geocoded_results_3000.rds")
data7 <- read_rds("data/geocoded_results_3500.rds")
data8 <- read_rds("data/geocoded_results_4000.rds")
data9 <- read_rds("data/geocoded_results_4500.rds")
data10 <- read_rds("data/geocoded_results_5000.rds")
data11 <- read_rds("data/geocoded_results_5500.rds")
data12 <- read_rds("data/geocoded_results_6000.rds")
data13 <- read_rds("data/geocoded_results_6410.rds")

## binding rows (making a full dataset)
shootings_w_geoid <- bind_rows(data1, data2, data3, data4, data5, data6, data7, data8, data9, data10, data11, data12, data13, .id = NULL)

## antijoining to figure out unmatched rows
unmatched <- anti_join(police_shootings, shootings_w_geoid, by=c("id"))

## so we have 1 less than the dataset, but it's Gary Brown, who was a bum geocode. 

### testing of joining census data

shootings_w_geoid <- get_acs(geography = "tract", state="MD", 
                       variables = c(popululation = "B02001_001",
                                median.gross.rent = "B25064_001",
                                median.household.income = "B19013_001",
                                rent.burden = "B25071_001",
                                white = "B03002_003", 
                                af.am = "B03002_004",
                                hispanic = "B03002_012",
                                am.ind = "B03002_005",
                                asian = "B03002_006",
                                nh.pi = "B03002_007",
                                multiple = "B03002_009",
                                other = "B03002_008"),
                          year= 2019)


## pivoting to columns 

pivot_wider(test_census, names_from = variable, names_sep = ".", values_from = c(estimate, moe))




### some mapping stuff below, is separate from the for loop
 
cxy_geography(longitude, latitude)

## mapping all the counties

## this is not really working rn but I am trying lol

ggplot() + 
  geom_sf(police_shootings_geom)
  geom_point(data=police_shootings, aes(x=longitude, y=latitude)) +
  geom_sf(data=usa_counties) + 
  theme_minimal() +
  geometry = geometry

```